<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.mapper.MusicMapper">

    <insert id="insert">
        insert into music (music_name, music_url, image_url, from_singer, lyric, timelength, activation, creat_time, listen_numb)
        values(#{musicName}, #{musicUrl}, #{imageUrl}, #{fromSinger}, #{lyric}, #{timelength}, #{activation}, #{creatTime}, #{listenNumb})
    </insert>

    <delete id="deleteById">
        delete from music where music_id = #{id}
    </delete>

    <update id="updateById">
        update music
        <set>
            <if test="musicName != null">music_name = #{musicName},</if>
            <if test="musicUrl != null">music_url = #{musicUrl},</if>
            <if test="imageUrl != null">image_url = #{imageUrl},</if>
            <if test="fromSinger != null">from_singer = #{fromSinger},</if>
            <if test="lyric != null">lyric = #{lyric},</if>
            <if test="timelength != null">timelength = #{timelength},</if>
            <if test="activation != null">activation = #{activation},</if>
            <if test="creatTime != null">creat_time = #{creatTime},</if>
            <if test="listenNumb != null">listen_numb = #{listenNumb}</if>
        </set>
        where music_id = #{musicId}
    </update>

    <select id="selectAll" resultType="com.example.entity.Music">
        SELECT m.*, u.username AS singerName
        FROM music m
        LEFT JOIN user u ON m.from_singer = u.id
        <where>
            <if test="musicName != null">
                m.music_name LIKE CONCAT('%', #{musicName}, '%')
            </if>
            <if test="fromSinger != null">
                AND m.from_singer = #{fromSinger}
            </if>
        </where>
        ORDER BY m.music_id ASC
    </select>

    <insert id="insertMusicTags">
        INSERT INTO music_tag (music_id, tag_id)
        VALUES
        <foreach collection="tagIds" item="tagId" separator=",">
            (#{musicId}, #{tagId})
        </foreach>
    </insert>

    <delete id="deleteMusicTags">
        DELETE FROM music_tag WHERE music_id = #{musicId}
    </delete>

</mapper> 